# ECS Configuration for dev-coffeezip-cms
# Usage:
#   aws cloudformation create-stack --stack-name ecs-cluster-dev-coffeezip \
#       --template-body file://cf-templates/ecs-cluster.yaml \
#       --parameters file://values/ecs-dev-coffeezip-cms.yaml

# Cluster Parameters
Cluster:
  Environment: dev
  SolutionName: coffeezip
  CapacityProviders: "FARGATE,FARGATE_SPOT"

# Task Definition Parameters
TaskDefinition:
  Environment: dev
  SolutionName: coffeezip
  ServiceName: cms
  ContainerImage: 365485194891.dkr.ecr.ap-northeast-2.amazonaws.com/coffeezip/coffeezip-cms:0.9.26-dev-33
  ContainerPort: 3849
  CPU: '512'
  Memory: '1024'
  TaskRoleArn: arn:aws:iam::365485194891:role/ecsTaskRole
  ExecutionRoleArn: arn:aws:iam::365485194891:role/ecsTaskExecutionRole
  HealthCheckPath: /api/ping
  HealthCheckInterval: 30
  HealthCheckTimeout: 5
  HealthCheckRetries: 2
  HealthCheckStartPeriod: 90
  StartTimeout: 90
  StopTimeout: 120
  EnvironmentVariables: |
    [
      {"name": "NODE_ENV", "value": "dev"},
      {"name": "PORT", "value": "3849"},
      {"name": "DATABASE_URL", "value": "mysql://admin:Q3QUpphmZpCuO5tzE5LC@cms-db-dev.global-gzdwcwpytq5l.global.rds.amazonaws.com:3306/coffeezip?connection_limit=5&spool_timeout=0"},
      {"name": "DATABASE_REPLICA_URL", "value": "mysql://admin:Q3QUpphmZpCuO5tzE5LC@cms-db-dev-cluster.cluster-ro-cb8gsouvnw6l.ap-northeast-2.rds.amazonaws.com:3306/coffeezip"},
      {"name": "REDIS_URL", "value": "redis://cms-dev-redis.syx1jj.clustercfg.apn2.cache.amazonaws.com:6379"},
      {"name": "JWT_SECRET", "value": "CoffeezipCms"},
      {"name": "JWT_EXPIRES_IN", "value": "24h"},
      {"name": "BCRYPT_ROUNDS", "value": "12"},
      {"name": "RATE_LIMIT_MAX", "value": "100"},
      {"name": "RATE_LIMIT_WRITE_MAX", "value": "50"},
      {"name": "MAX_REQUEST_SIZE", "value": "5242880"},
      {"name": "LOG_LEVEL", "value": "info"},
      {"name": "LOG_DIR", "value": "./logs"},
      {"name": "LOG_RETENTION_DAYS", "value": "30"},
      {"name": "SECURE_MODE", "value": "false"},
      {"name": "CMS_URL", "value": "https://dev.nextpay.co.kr"},
      {"name": "COFFEEZIP_URL", "value": "https://coffeezip-dev.nextpay.co.kr"},
      {"name": "COFFEEZIP_CMS_IOT_URL", "value": "https://coffeezip-cms-iot-dev.nextpay.co.kr"}
    ]

# Service Parameters
Service:
  Environment: dev
  SolutionName: coffeezip
  ServiceName: cms
  ClusterStackName: ecs-cluster-dev-coffeezip
  TaskDefinitionStackName: ecs-taskdef-dev-coffeezip-cms
  DesiredCount: 1
  TargetGroupArn: arn:aws:elasticloadbalancing:ap-northeast-2:365485194891:targetgroup/group-dev-coffeezip-cms/9d8d0b6852b1bdd3
  ContainerName: coffeezip-cms
  ContainerPort: 3849
  SubnetIds: "subnet-08be2b5dba489c093,subnet-0aa888b710602c0be,subnet-0efb01644999a3129"
  SecurityGroupIds: "sg-0d856c4c37acc59c5,sg-51a84037,sg-0d85874bcf3eaa229"
  AssignPublicIp: ENABLED
  CapacityProvider: FARGATE
  CapacityProviderWeight: 1
  MaximumPercent: 200
  MinimumHealthyPercent: 100
  DeploymentCircuitBreakerEnabled: 'true'
  DeploymentCircuitBreakerRollback: 'true'
  HealthCheckGracePeriodSeconds: 90
  EnableExecuteCommand: 'true'

# Auto Scaling Parameters
AutoScaling:
  Environment: dev
  SolutionName: coffeezip
  ServiceName: cms
  ClusterStackName: ecs-cluster-dev-coffeezip
  ServiceStackName: ecs-service-dev-coffeezip-cms
  MinCapacity: 1
  MaxCapacity: 3
  TargetCPUUtilization: 70
  ScaleInCooldown: 120
  ScaleOutCooldown: 60
  DisableScaleIn: 'false'
